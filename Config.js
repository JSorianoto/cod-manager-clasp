// ===================================================================
// CONFIGURACI√ìN DEL SISTEMA COD MANAGER
// ===================================================================
// Archivo: Config.gs
// Descripci√≥n: Configuraci√≥n centralizada y constantes del sistema
// ===================================================================

// ==== CONFIGURACI√ìN PRINCIPAL ====

/**
 * Configuraci√≥n principal del sistema COD Manager
 * Modificar estos valores para ajustar el comportamiento del sistema
 */
const CONFIG = {
  
  // ==== CONFIGURACI√ìN GENERAL ====
  version: '2.0.0',
  nombre: 'COD Manager Pro',
  desarrollador: 'Sistema Antifraude Integrado',
  
  // ==== MAPEO DE COLUMNAS ORDERS ====
  columnas: {
    orders: {
      fecha: 3,          // D - Fecha del pedido
      id: 4,             // E - ID del pedido
      nombre: 5,         // F - Nombre del cliente
      telefono: 6,       // G - Tel√©fono
      confirmacion: 14,  // O - Estado de confirmaci√≥n
      estado: 15,        // P - Estado del pedido
      ip: 13,            // N - IP del pedido
      datosCompletos: 16, // Q - Datos completos del pedido
      analisisFraude: 17  // R - An√°lisis antifraude
    },
    
    worksheet: {
      id: 1,        // B - ID del pedido con formato
      estado: 7,    // H - Estado
      nombre: 8,    // I - Nombre del cliente
      telefono: 10  // K - Tel√©fono
    }
  },
  
  // ==== ESTADOS Y CONVERSIONES ====
  estados: {
    conversion: {
      'Charged': 'Entregado',
      'Delivered': 'Entregado', 
      'Reject': 'Devolucion',
      'Incidence': 'INCIDENCIA'
    },
    
    confirmados: ['DIRECT', 'WAC', 'CC', 'SHOPIFY'],
    
    finales: ['Entregado', 'I. ENTREGADO', 'Devolucion'],
    
    noActualizar: ['FALLO AGENCIA', 'NO CONFIRMADO'],
    
    incidenciaResuelta: {
      desde: 'INCIDENCIA',
      hacia: 'Entregado',
      resultado: 'I. ENTREGADO'
    }
  } 
};

// ==== MAPEO ESTADOS DROPEA ====
/**
 * Conversi√≥n de estados devueltos por la API de Dropea
 * hacia los valores utilizados en la hoja ORDERS.
 */
const DROPEA_STATUS_MAP = {
  'DELIVERED': 'Entregado',
  'CHARGED': 'Entregado',
  'REJECTED': 'Devolucion',
  'CANCELLED': 'Devolucion',
  'RETURNED': 'Devolucion',
  'TRANSIT': 'En tr√°nsito',
  'PREPARED': 'En tr√°nsito',
  'PENDING': 'En tr√°nsito',
  'INCIDENCE': 'INCIDENCIA'
};

/**
 * Devuelve el estado equivalente usado en la hoja ORDERS.
 * Si el valor proporcionado no est√° en el mapeo,
 * se devuelve "INCIDENCIA".
 */
function convertirEstadoDropea(estado) {
  return DROPEA_STATUS_MAP[estado] || 'INCIDENCIA';
}

// ==== CONFIGURACI√ìN SISTEMA ANTIFRAUDE ====

/**
 * Configuraci√≥n espec√≠fica del sistema de detecci√≥n de fraude
 */
const FRAUD_CONFIG = {
  
  // ==== PUNTUACIONES DE RIESGO ====
  puntuaciones: {
    // Geolocalizaci√≥n
    ipExtranjera: 4,              // IP desde fuera de Espa√±a
    ipProvinciaLejana: 3,         // IP desde provincia muy alejada
    ipProvinciaDistinta: 2,       // IP desde provincia diferente
    ipNoLocalizable: 1,           // IP que no se puede localizar
    
    // Repetici√≥n de IP
    ipRepetida2Horas: 3,          // 2+ pedidos con misma IP en 2 horas
    ipRepetidaMismoDia: 2,        // 2+ pedidos con misma IP mismo d√≠a
    ipRepetidaUnaVez: 1,          // IP usada 2 veces en el d√≠a
    
    // M√∫ltiples direcciones
    ip4DireccionesMas: 3,         // IP usada en 4+ direcciones diferentes
    ip3Direcciones: 2,            // IP usada en 3 direcciones diferentes
    ip2Direcciones: 1             // IP usada en 2 direcciones diferentes
  },
  
  // ==== UMBRALES DE CLASIFICACI√ìN ====
  umbrales: {
    confiable: {
      min: 0,
      max: 2,
      etiqueta: '‚úÖ CONFIABLE',
      color: '#4CAF50',
      accion: 'Procesar normalmente'
    },
    
    revisar: {
      min: 3,
      max: 5,
      etiqueta: '‚ö†Ô∏è REVISAR',
      color: '#FF9800',
      accion: 'Verificaci√≥n manual recomendada'
    },
    
    sospechoso: {
      min: 6,
      max: 10,
      etiqueta: 'üö® SOSPECHOSO',
      color: '#f44336',
      accion: 'Revisi√≥n obligatoria antes de procesar'
    }
  },
  
  // ==== CONFIGURACI√ìN DE AN√ÅLISIS ====
  analisis: {
    ventanaHorasRepeticion: 2,    // Horas para considerar repetici√≥n sospechosa
    maximoDireccionesPorIP: 4,    // M√°ximo direcciones diferentes por IP
    pausaEntreConsultas: 100,     // Milisegundos entre consultas API
    timeoutAPI: 5000,             // Timeout para consultas API en ms
    
    // Provincias consideradas "muy lejanas" entre s√≠
    provinciasMuyLejanas: [
      'canarias', 'baleares', 'ceuta', 'melilla'
    ]
  },

  // ==== CONFIGURACI√ìN DE HISTORIAL ====
  historial: {
    diasAnalisis: 30,             // D√≠as hacia atr√°s para revisar historial
    repeticionesSospechosas: 3,   // Pedidos previos necesarios para sumar puntos
    puntosPorRepeticion: 2        // Puntos extra al superar el umbral
  },

  // ==== CONFIGURACI√ìN DE APIs ====
  apis: {
    geolocalizacion: {
      proveedor: 'ip-api.com',
      url: 'http://ip-api.com/json/',
      camposConsulta: 'status,country,regionName,region,city',
      idioma: 'es',
      limiteMensual: 1000,
      cacheDuracion: 86400 // 24 horas en segundos
    }
  }
};

// ==== MAPEO DE PROVINCIAS ESPA√ëOLAS ====

/**
 * Mapeo de c√≥digos de provincia a nombres completos
 * Usado para comparar ubicaci√≥n IP con direcci√≥n de entrega
 */
const MAPA_PROVINCIAS = {
  'A': 'alicante',
  'AB': 'albacete', 
  'AL': 'almer√≠a',
  'AV': '√°vila',
  'B': 'barcelona',
  'BA': 'badajoz',
  'BI': 'bizkaia',
  'BU': 'burgos',
  'C': 'coru√±a',
  'CA': 'c√°diz',
  'CC': 'c√°ceres',
  'CO': 'c√≥rdoba',
  'CR': 'ciudad real',
  'CS': 'castell√≥n',
  'CU': 'cuenca',
  'GC': 'las palmas',
  'GI': 'girona',
  'GR': 'granada',
  'GU': 'guadalajara',
  'H': 'huelva',
  'HU': 'huesca',
  'J': 'ja√©n',
  'L': 'lleida',
  'LE': 'le√≥n',
  'LO': 'la rioja',
  'LU': 'lugo',
  'M': 'madrid',
  'MA': 'm√°laga',
  'MU': 'murcia',
  'NA': 'navarra',
  'O': 'asturias',
  'OR': 'ourense',
  'P': 'palencia',
  'PM': 'baleares',
  'PO': 'pontevedra',
  'S': 'cantabria',
  'SA': 'salamanca',
  'SE': 'sevilla',
  'SG': 'segovia',
  'SO': 'soria',
  'SS': 'gipuzkoa',
  'T': 'tarragona',
  'TE': 'teruel',
  'TF': 'santa cruz de tenerife',
  'TO': 'toledo',
  'V': 'valencia',
  'VA': 'valladolid',
  'VI': 'araba',
  'Z': 'zaragoza',
  'ZA': 'zamora'
};

// ==== CONFIGURACI√ìN DE LOGS Y AUDITOR√çA ====

/**
 * Configuraci√≥n del sistema de logs y auditor√≠a
 */
const LOG_CONFIG = {
  
  hojas: {
    actualizaciones: 'LOG_ACTUALIZACIONES',
    antifraude: 'LOG_ANTIFRAUDE',
    bot: 'LOG_BOT'
  },
  
  encabezados: {
    actualizaciones: [
      'Fecha/Hora', 'Tipo', 'ID Pedido', 'Nombre Cliente', 
      'Estado Anterior', 'Estado Nuevo', 'Usuario', 'Observaciones'
    ],
    antifraude: [
      'Fecha/Hora', 'Tipo An√°lisis', 'Pedidos Analizados',
      'Sospechosos Detectados', 'Tasa Detecci√≥n', 'Usuario'
    ],
    bot: [
      'Fecha/Hora', 'Evento', 'Detalle', 'Usuario'
    ]
  },
  
  colores: {
    encabezados: '#f1f3f4',
    encabezadosAntifraude: '#fff3e0',
    encabezadosBot: '#e8eaf6'
  },
  
  retencion: {
    mesesAntiguedad: 3, // Meses antes de limpiar logs antiguos
    limpiezaAutomatica: true
  }
};

// ==== CONFIGURACI√ìN DE NOTIFICACIONES ====

/**
 * Configuraci√≥n del sistema de notificaciones
 */
const NOTIFICATION_CONFIG = {
  
  email: {
    habilitado: false, // Cambiar a true para habilitar emails
    remitente: '', // Email del remitente
    asuntoPrefijo: 'üö® COD Manager: '
  },
  
  umbrales: {
    notificarSiSospechosos: 1, // Notificar si hay 1+ pedidos sospechosos
    notificarSiTasaAlta: 10    // Notificar si tasa de fraude > 10%
  },
  
  plantillas: {
    fraudeDetectado: {
      asunto: 'Pedidos sospechosos detectados',
      cuerpo: `Se han detectado {CANTIDAD} pedidos sospechosos que requieren revisi√≥n:

{LISTA_PEDIDOS}

Revisa estos pedidos en la hoja ORDERS (columna R) antes de procesarlos.

An√°lisis realizado el {FECHA} por {USUARIO}`
    }
  }
};

// ==== CONFIGURACI√ìN DE MANTENIMIENTO ====

/**
 * Configuraci√≥n del sistema de mantenimiento autom√°tico
 */
const MAINTENANCE_CONFIG = {
  
  cache: {
    limpiezaAutomatica: true,
    duracionIP: 86400, // 24 horas en segundos
    maximoEntradas: 1000
  },
  
  limpieza: {
    ejecutarAutomaticamente: true,
    frecuenciaDias: 7, // Cada 7 d√≠as
    mantenerLogsMeses: 3
  },
  
  validaciones: {
    verificarEstructura: true,
    repararAutomaticamente: false,
    notificarProblemas: true
  }
};

// ==== FUNCIONES DE ACCESO A CONFIGURACI√ìN ====

/**
 * Obtiene la configuraci√≥n completa del sistema
 */
function obtenerConfiguracionCompleta() {
  return {
    general: CONFIG,
    fraude: FRAUD_CONFIG,
    provincias: MAPA_PROVINCIAS,
    logs: LOG_CONFIG,
    notificaciones: NOTIFICATION_CONFIG,
    mantenimiento: MAINTENANCE_CONFIG
  };
}

/**
 * Obtiene configuraci√≥n espec√≠fica del sistema antifraude
 */
function obtenerConfigFraude() {
  return FRAUD_CONFIG;
}

/**
 * Obtiene el mapeo de provincias
 */
function obtenerMapaProvincias() {
  return MAPA_PROVINCIAS;
}

/**
 * Devuelve el mapeo de columnas para la hoja ORDERS
 */
function obtenerColumnasOrders() {
  return CONFIG.columnas.orders;
}

/**
 * Obtiene configuraci√≥n de una secci√≥n espec√≠fica
 */
function obtenerConfigSeccion(seccion) {
  const configs = {
    'general': CONFIG,
    'fraude': FRAUD_CONFIG,
    'provincias': MAPA_PROVINCIAS,
    'logs': LOG_CONFIG,
    'notificaciones': NOTIFICATION_CONFIG,
    'mantenimiento': MAINTENANCE_CONFIG
  };
  
  return configs[seccion] || null;
}

/**
 * Actualiza configuraci√≥n de una secci√≥n espec√≠fica
 * USAR CON PRECAUCI√ìN - Solo para ajustes avanzados
 */
function actualizarConfigSeccion(seccion, nuevaConfig) {
  try {
    // Validar que la secci√≥n existe
    if (!obtenerConfigSeccion(seccion)) {
      throw new Error(`Secci√≥n de configuraci√≥n no encontrada: ${seccion}`);
    }
    
    // Aqu√≠ se podr√≠a implementar validaci√≥n espec√≠fica por secci√≥n
    // y persistencia en hoja de configuraci√≥n
    
    Logger.log(`Configuraci√≥n actualizada para secci√≥n: ${seccion}`);
    return true;
    
  } catch (error) {
    Logger.log(`Error actualizando configuraci√≥n: ${error.toString()}`);
    return false;
  }
}

// ==== FUNCIONES DE VALIDACI√ìN DE CONFIGURACI√ìN ====

/**
 * Valida que la configuraci√≥n del sistema sea correcta
 */
function validarConfiguracion() {
  const errores = [];
  
  try {
    // Validar configuraci√≥n general
    if (!CONFIG.version || !CONFIG.nombre) {
      errores.push('Configuraci√≥n general incompleta');
    }
    
    // Validar configuraci√≥n de fraude
    if (!FRAUD_CONFIG.puntuaciones || !FRAUD_CONFIG.umbrales) {
      errores.push('Configuraci√≥n de fraude incompleta');
    }
    
    // Validar umbrales l√≥gicos
    const umbrales = FRAUD_CONFIG.umbrales;
    if (umbrales.confiable.max >= umbrales.revisar.min) {
      errores.push('Umbrales de clasificaci√≥n superpuestos');
    }
    
    // Validar configuraci√≥n de API
    if (!FRAUD_CONFIG.apis.geolocalizacion.url) {
      errores.push('URL de API de geolocalizaci√≥n no configurada');
    }
    
    return {
      valida: errores.length === 0,
      errores: errores
    };
    
  } catch (error) {
    return {
      valida: false,
      errores: [`Error validando configuraci√≥n: ${error.toString()}`]
    };
  }
}

/**
 * Muestra informaci√≥n del sistema y configuraci√≥n actual
 */
function mostrarInfoSistema() {
  const config = obtenerConfiguracionCompleta();
  const validacion = validarConfiguracion();
  
  const info = `
=== COD MANAGER - INFORMACI√ìN DEL SISTEMA ===

Versi√≥n: ${config.general.version}
Nombre: ${config.general.nombre}
Desarrollador: ${config.general.desarrollador}

=== CONFIGURACI√ìN ANTIFRAUDE ===
API Geolocalizaci√≥n: ${config.fraude.apis.geolocalizacion.proveedor}
L√≠mite mensual API: ${config.fraude.apis.geolocalizacion.limiteMensual}
Provincias mapeadas: ${Object.keys(config.provincias).length}

=== UMBRALES DE CLASIFICACI√ìN ===
Confiable: ${config.fraude.umbrales.confiable.min}-${config.fraude.umbrales.confiable.max} puntos
Revisar: ${config.fraude.umbrales.revisar.min}-${config.fraude.umbrales.revisar.max} puntos  
Sospechoso: ${config.fraude.umbrales.sospechoso.min}-${config.fraude.umbrales.sospechoso.max} puntos

=== ESTADO DE CONFIGURACI√ìN ===
V√°lida: ${validacion.valida ? 'S√ç' : 'NO'}
${validacion.errores.length > 0 ? 'Errores: ' + validacion.errores.join(', ') : ''}

=== FECHA DE CONSULTA ===
${new Date().toLocaleString('es-ES')}
`;

  Logger.log(info);
  return info;
}